<!doctype html>
<html>

<head>
	<link rel="apple-touch-icon" href="/sq-apple-touch-icon.png" />
	<link rel="icon" type="image/png" href="/sq-apple-touch-icon.png" />
	<link href="/app.css" rel="stylesheet" />
	<style>
		#apple-pay-button {
			height: 48px;
			width: 100%;
			display: inline-block;
			-webkit-appearance: -apple-pay-button;
			-apple-pay-button-type: plain;
			-apple-pay-button-style: black;
		}

		#tokenize-button {
			background-color: #007aff;
			color: white;
			border: none;
			border-radius: 4px;
			padding: 12px 20px;
			font-size: 16px;
			cursor: pointer;
			margin-top: 15px;
		}
	</style>
	<script type="application/javascript"
		src="//cdn.rawgit.com/Alorel/console-log-html/master/console-log-html.min.js"></script>
	<script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
	<script>
		const appId = 'sq0idp-wLM4vHTsA4vpk6eMflCqvQ';
		const locationId = 'JD093NMTT4DSM';

		async function initializeCard(payments) {
			const card = await payments.card();
			await card.attach('#card-container');

			return card;
		}

		function buildPaymentRequest(payments) {
			return payments.paymentRequest({
				countryCode: 'US',
				currencyCode: 'USD',
				total: {
					amount: '1.00',
					label: 'Total',
				},
			});
		}

		async function initializeApplePay(payments) {
			const paymentRequest = buildPaymentRequest(payments);
			const applePay = await payments.applePay(paymentRequest);
			// Note: You do not need to `attach` applePay.
			return applePay;
		}

		async function initializeGooglePay(payments) {
			const paymentRequest = buildPaymentRequest(payments);
			const googlePay = await payments.googlePay(paymentRequest);
			await googlePay.attach('#google-pay-button');
			return googlePay;
		}

		async function createPayment(token) {
			const body = JSON.stringify({
				locationId,
				sourceId: token,
				idempotencyKey: window.crypto.randomUUID(),
			});

			const paymentResponse = await fetch('/payment', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body,
			});

			if (paymentResponse.ok) {
				return paymentResponse.json();
			}

			const errorBody = await paymentResponse.text();
			throw new Error(errorBody);
		}

		// Change the parameter to 'paymentMethod'
		async function tokenize(paymentMethod) {
			let tokenResult;
			const customTokenizeArgsTextarea = document.getElementById('tokenize-args');
			const jsonValidationError = document.getElementById('json-validation-error');
			
			// Clear any previous validation errors
			jsonValidationError.style.display = 'none';
			jsonValidationError.textContent = '';

			// Check if custom JSON arguments are provided
			const customTokenizeArgsText = customTokenizeArgsTextarea.value.trim();
			
			if (customTokenizeArgsText) {
				try {
					// Parse and validate the JSON input
					const tokenizeArgs = JSON.parse(customTokenizeArgsText);
					console.log('Using custom tokenize arguments:', tokenizeArgs);
					tokenResult = await paymentMethod.tokenize(tokenizeArgs);
				} catch (parseError) {
					// Show JSON validation error
					jsonValidationError.textContent = `Invalid JSON: ${parseError.message}`;
					jsonValidationError.style.display = 'block';
					throw new Error(`Invalid JSON in custom arguments: ${parseError.message}`);
				}
			} else {
				tokenResult = await paymentMethod.tokenize();
			}

			if (tokenResult.status === 'OK') {
				return tokenResult.token;
			} else {
				let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
				if (tokenResult.errors) {
					errorMessage += ` and errors: ${JSON.stringify(
						tokenResult.errors,
					)}`;
				}

				throw new Error(errorMessage);
			}
		}

		// status is either SUCCESS or FAILURE;
		function displayPaymentResults(status) {
			const statusContainer = document.getElementById(
				'payment-status-container',
			);
			if (status === 'SUCCESS') {
				statusContainer.classList.remove('is-failure');
				statusContainer.classList.add('is-success');
			} else {
				statusContainer.classList.remove('is-success');
				statusContainer.classList.add('is-failure');
			}

			statusContainer.style.visibility = 'visible';
		}

		document.addEventListener('DOMContentLoaded', async function () {
			if (!window.Square) {
				throw new Error('Square.js failed to load properly');
			}

			ConsoleLogHTML.connect(document.getElementById("console-output"));

			let payments;
			try {
				payments = window.Square.payments(appId, locationId);
			} catch {
				const statusContainer = document.getElementById(
					'payment-status-container',
				);
				statusContainer.className = 'missing-credentials';
				statusContainer.style.visibility = 'visible';
				return;
			}

			let card;
			try {
				card = await initializeCard(payments);
			} catch (e) {
				console.error('Initializing Card failed', e);
				return;
			}

			let applePay;
			try {
				applePay = await initializeApplePay(payments);
			} catch (e) {
				console.error('Initializing Apple Pay failed', e);
				// There are a number of reason why Apple Pay may not be supported
				// (e.g. Browser Support, Device Support, Account). Therefore you should handle
				// initialization failures, while still loading other applicable payment methods.
			}

			let googlePay;
			try {
				googlePay = await initializeGooglePay(payments);
			} catch (e) {
				console.error('Initializing Google Pay failed', e);
			}

			async function handlePaymentMethodSubmission(event, paymentMethod) {
				event.preventDefault();

				try {
					// disable the submit button as we await tokenization and make a payment request.
					cardButton.disabled = true;
					// await new Promise(resolve => setTimeout(resolve, 10000));
					const token = await tokenize(paymentMethod);
					console.log(`${token}`);
					// Uncomment to charge the card.
					// const paymentResults = await createPayment(token);
					// console.debug('Payment Success', paymentResults);
					displayPaymentResults('SUCCESS');
				} catch (e) {
					displayPaymentResults('FAILURE');
					console.error(`${e.message}`);
				} finally {
					cardButton.disabled = false;
				}
			}

			const cardButton = document.getElementById('tokenize-button');
			cardButton.addEventListener('click', async function (event) {
				await handlePaymentMethodSubmission(event, card);
			});

			// Populate textarea from URL param if present
			const urlParams = new URLSearchParams(window.location.search);
			const tokenizeArgsParam = urlParams.get('tokenizeArgs');
			const tokenizeArgsTextarea = document.getElementById('tokenize-args');
			if (tokenizeArgsParam) {
				try {
					tokenizeArgsTextarea.value = JSON.stringify(JSON.parse(tokenizeArgsParam), null, 2);
				} catch {
					tokenizeArgsTextarea.value = tokenizeArgsParam;
				}
			}

			function syncUrlParam() {
				const url = new URL(window.location);
				if (tokenizeArgsTextarea.value.trim()) {
					url.searchParams.set('tokenizeArgs', tokenizeArgsTextarea.value.trim());
				} else {
					url.searchParams.delete('tokenizeArgs');
				}
				history.replaceState(null, '', url);
			}

			tokenizeArgsTextarea.addEventListener('input', syncUrlParam);

			// Add event listeners for the tokenize arguments buttons
			const loadExampleButton = document.getElementById('load-example-args');
			const clearArgsButton = document.getElementById('clear-args');

			loadExampleButton.addEventListener('click', function() {
				const exampleArgs = {
					intent: 'RECURRING_CHARGE',
					recurringPaymentRequest: {
						managementURL: 'https://example.com/manage-subscription',
						paymentDescription: 'Monthly subscription to Premium Service',
						regularBilling: {
							amount: '1.00',
							label: 'Monthly Subscription',
							startDate: new Date(
								Date.now() + 30 * 24 * 60 * 60 * 1000,
							).toISOString().split('T')[0],
						},
						trialBilling: {
							amount: '0.00',
							label: 'Trial Period (1 month)',
							startDate: new Date(
								Date.now(),
							).toISOString().split('T')[0],
						},
					},
				};
				tokenizeArgsTextarea.value = JSON.stringify(exampleArgs, null, 2);
				// Clear any validation errors when loading example
				document.getElementById('json-validation-error').style.display = 'none';
				syncUrlParam();
			});

			clearArgsButton.addEventListener('click', function() {
				tokenizeArgsTextarea.value = '';
				// Clear any validation errors when clearing
				document.getElementById('json-validation-error').style.display = 'none';
				syncUrlParam();
			});

			// Checkpoint 2.
			if (applePay) {
				const applePayButton = document.getElementById('apple-pay-button');
				applePayButton.addEventListener('click', async function (event) {
					await handlePaymentMethodSubmission(event, applePay);
				});
			}

			if (googlePay) {
				const googlePayButton = document.getElementById('google-pay-button');
				googlePayButton.addEventListener('click', async function (event) {
					await handlePaymentMethodSubmission(event, googlePay);
				});
			}
		});
	</script>
</head>

<body>
	<form id="payment-form">
		<div id="apple-pay-button"></div>
		<div id="google-pay-button"></div>
		<div id="card-container"></div>
		<div id="options-container">
			<!-- Multi-line input for custom tokenize arguments -->
			<div style="margin-top: 15px;">
				<label for="tokenize-args">Custom tokenize arguments (JSON):</label>
				<div style="margin-top: 5px; margin-bottom: 5px;">
					<button type="button" id="load-example-args" style="font-size: 12px; padding: 4px 8px;">Load Apple Pay RECURRING_CHARGE Example</button>
					<button type="button" id="clear-args" style="font-size: 12px; padding: 4px 8px; margin-left: 5px;">Clear</button>
				</div>
				<textarea 
					id="tokenize-args" 
					rows="12" 
					cols="50" 
					placeholder="Enter JSON object for tokenize arguments (leave empty to not pass any arguments)"
					style="width: 100%; font-family: monospace; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; padding: 8px;"
				></textarea>
				<div id="json-validation-error" style="color: red; font-size: 12px; margin-top: 5px; display: none;"></div>
			</div>
		</div>
		<button id="tokenize-button" type="button">Tokenize</button>
	</form>
	<div id="payment-status-container"></div>
	<ul id="console-output"></ul>
</body>

</html>
